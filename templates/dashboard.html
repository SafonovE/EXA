<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>üìä –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –î–∞—à–±–æ—Ä–¥ –ò–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤</title>

  <!-- Chart.js –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* =====================================================
       –¶–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞ Sega-–ø–∞—Å—Ç–µ–ª—å
    ===================================================== */
    :root {
      --primary:           #0050A0;        /* –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∏–Ω–∏–π */
      --accent:            #00A1E9;        /* –≥–æ–ª—É–±–æ–π —Ö–æ–≤–µ—Ä */
      --bg:                #F0F8FF;        /* —Ñ–æ–Ω —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
      --card-bg:           #FFFFFF;        /* —Ñ–æ–Ω –∫–∞—Ä—Ç–æ—á–µ–∫ */
      --text:              #333333;        /* –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç */
      --border:            #DDDDDD;        /* —Ä–∞–º–∫–∏ */
      --badge-bg:          #0050A0;        /* —Ñ–æ–Ω –±–µ–π–¥–∂–µ–π */
      --badge-text:        #FFFFFF;        /* —Ç–µ–∫—Å—Ç –±–µ–π–¥–∂–µ–π */
      --highlight-bg:      rgba(255,255,0,0.3); /* –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –∂—ë–ª—Ç—ã–π */
      --highlight-outline: #FF0000;        /* –∫—Ä–∞—Å–Ω–∞—è –æ–±–≤–æ–¥–∫–∞ */
    }

    /* --------------------------------------------
       –°–±—Ä–æ—Å –æ—Ç—Å—Ç—É–ø–æ–≤/–ø–∞–¥–¥–∏–Ω–≥–æ–≤, –±–∞–∑–æ–≤–∞—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞
    -------------------------------------------- */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0; padding: 0;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', sans-serif;
      line-height: 1.5;
    }

    /* --------------------------
       –®–∞–ø–∫–∞ —Å–∞–π—Ç–∞
    -------------------------- */
    header {
      background: var(--primary);
      color: white;
      text-align: center;
      padding: 20px;
      font-size: 1.75rem;
      font-weight: bold;
    }

    /* --------------------------
       –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    -------------------------- */
    main {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
    }

    /* =================================================
       –û–≤–µ—Ä–ª–µ–π –∏ —Ç–æ—Å—Ç –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏
    ================================================= */
    #loader-overlay {
      position: fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.6);
      display: none; align-items:center; justify-content:center;
      flex-direction:column; z-index:1000;
      color:white; font-size:1.2rem; font-weight:bold;
    }
    #loader-overlay .spinner {
      width:60px; height:60px;
      border:8px solid rgba(255,255,255,0.3);
      border-top-color:white;
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin-bottom:12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    #upload-toast {
      position:fixed; top:20px; left:50%;
      transform:translateX(-50%);
      padding:12px 24px;
      background:var(--primary);
      color:white;
      border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
      display:none; z-index:1100; font-weight:bold;
      animation:slideDown 0.5s ease-out forwards;
    }
    @keyframes slideDown {
      from { opacity:0; transform: translate(-50%,-50px); }
      to   { opacity:1; transform: translate(-50%,0); }
    }

    /* --------------------------
       –§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
    -------------------------- */
    .upload {
      display:flex; gap:8px; margin-bottom:20px;
    }
    .upload input[type="file"] {
      flex:1; padding:6px; border:1px solid var(--border);
      border-radius:6px; background:var(--card-bg);
    }
    .upload button {
      padding:8px 16px; background:var(--primary);
      color:white; border:none; border-radius:6px;
      cursor:pointer; font-weight:600;
      transition:background 0.2s;
    }
    .upload button:hover {
      background:var(--accent);
    }

    /* --------------------------
       –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–µ—Ä–∏–æ–¥–æ–≤
    -------------------------- */
    nav {
      display:flex; flex-wrap:wrap; gap:8px;
      margin-bottom:20px;
    }
    nav a {
      background:var(--card-bg); color:var(--text);
      padding:8px 16px; border:1px solid var(--border);
      border-radius:6px; text-decoration:none;
      font-weight:600; transition:background 0.2s, color 0.2s;
    }
    nav a:hover, nav a.active {
      background:var(--primary); color:white;
      border-color:var(--primary);
    }

    /* --------------------------
       –°–≤–æ–π –ø–µ—Ä–∏–æ–¥
    -------------------------- */
    .custom-period {
      display:flex; flex-wrap:wrap; gap:12px;
      align-items:center; margin-bottom:20px;
    }
    .custom-period label { font-weight:600; }
    .custom-period input, .custom-period select {
      padding:6px 8px; border:1px solid var(--border);
      border-radius:6px; background:var(--card-bg);
    }
    .custom-period button {
      padding:6px 12px; background:var(--primary);
      color:white; border:none; border-radius:6px;
      cursor:pointer; transition:background 0.2s;
    }
    .custom-period button:hover {
      background:var(--accent);
    }

    /* --------------------------
       –°–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫
    -------------------------- */
    .flex {
      display:flex; flex-wrap:wrap; gap:20px;
    }
    .card {
      background:var(--card-bg);
      border:1px solid var(--border);
      border-radius:8px;
      padding:20px;
      flex:1 1 calc(50% - 20px);
      box-shadow:0 2px 8px rgba(0,0,0,0.05);
    }
    .card.full { flex:1 1 100%; }
    .card h3 {
      margin-bottom:12px;
      color:var(--primary);
      font-size:1.25rem;
      font-weight:700;
    }

    /* --------------------------
       –ê–∫–∫–æ—Ä–¥–µ–æ–Ω—ã
    -------------------------- */
    details { margin-top:10px; }
    details summary {
      background:var(--primary); color:white;
      padding:6px 10px; font-size:0.95rem;
      border-radius:6px; cursor:pointer;
      font-weight:600; transition:background 0.2s;
      display:flex; justify-content:space-between;
      align-items:center;
    }
    details summary:hover {
      background:var(--accent);
    }
    details[open] summary {
      background:var(--card-bg); color:var(--text);
    }

    /* --------------------------
       –ë–µ–π–¥–∂–∏
    -------------------------- */
    .count-badge {
      background:var(--badge-bg);
      color:var(--badge-text);
      border-radius:12px; padding:2px 8px;
      font-size:0.85rem; font-weight:bold;
      margin-left:12px;
    }
    .badges, .jira-container {
      display:flex; flex-wrap:wrap; gap:6px;
      margin-top:8px; padding-right:4px;
      max-height:200px; overflow-y:auto;
    }
    .badge, .jira-link {
      padding:4px 8px; font-size:0.85rem;
      border-radius:10px; font-weight:600;
      text-decoration:none; transition:background 0.2s;
      display:inline-block;
      background:var(--badge-bg); color:var(--badge-text);
    }
    .badge:hover {
      background:var(--accent); color:white;
    }
    /* –∞–∫—Ç–∏–≤–Ω—ã–π –±–µ–π–¥–∂ */
    .badge.active {
      background:#FFD700 !important; /* –∂—ë–ª—Ç—ã–π */
      color:#000 !important;         /* —á—ë—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç */
      outline:3px solid var(--highlight-outline) !important;
    }
    .jira-link {
      background:var(--accent); color:black;
    }
    .jira-link:hover {
      background:var(--primary); color:white;
    }

    /* --------------------------
       –ü–æ–¥—Å–≤–µ—Ç–∫–∞ summary
    -------------------------- */
    .highlight {
      background:var(--highlight-bg) !important;
      outline:3px solid var(--highlight-outline) !important;
      color:#000 !important; font-weight:bold !important;
    }

    /* --------------------------
       –ì—Ä–∞—Ñ–∏–∫
    -------------------------- */
    #chart-container {
      background:var(--bg);
      padding:16px; border-radius:8px; margin-bottom:20px;
    }
    #incidentChart {
      width:100%!important; height:400px!important;
    }
  </style>
</head>
<body>
  <header>üìä –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –î–∞—à–±–æ—Ä–¥ –ò–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤</header>
  <main>
    <!-- –û–≤–µ—Ä–ª–µ–π –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loader-overlay">
      <div class="spinner"></div>
      <div id="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    <!-- –¢–æ—Å—Ç -->
    <div id="upload-toast"></div>

    <!-- –§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <form class="upload" id="upload-form" method="post" enctype="multipart/form-data">
      <input type="file" name="file" required>
      <button type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </form>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–µ—Ä–∏–æ–¥–æ–≤ -->
    <nav>
      {% for key,label in periods.items() %}
        <a href="/?period={{key}}
                   {% if from_date %}&from_date={{from_date}}{% endif %}
                   {% if to_date   %}&to_date={{to_date}}{% endif %}
                   {% if group_by  %}&group_by={{group_by}}{% endif %}"
           class="{% if selected==key %}active{% endif %}">
          {{label}}
        </a>
      {% endfor %}
    </nav>

    <!-- –°–≤–æ–π –ø–µ—Ä–∏–æ–¥ -->
    {% if selected=='custom' %}
      <div class="custom-period">
        <label>–°:</label>
        <input type="date" id="from_date" name="from_date" value="{{from_date}}">
        <label>–ü–æ:</label>
        <input type="date" id="to_date"   name="to_date"   value="{{to_date}}">
        <label>–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ:</label>
        <select id="group_by" name="group_by">
          <option value="D" {% if group_by=='D' %}selected{% endif %}>–î–µ–Ω—å</option>
          <option value="W" {% if group_by=='W' %}selected{% endif %}>–ù–µ–¥–µ–ª—è</option>
          <option value="M" {% if group_by=='M' %}selected{% endif %}>–ú–µ—Å—è—Ü</option>
          <option value="Q" {% if group_by=='Q' %}selected{% endif %}>–ö–≤–∞—Ä—Ç–∞–ª</option>
          <option value="Y" {% if group_by=='Y' %}selected{% endif %}>–ì–æ–¥</option>
        </select>
        <button id="apply-custom">–ü–æ–∫–∞–∑–∞—Ç—å</button>
      </div>
    {% endif %}

    <!-- –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö -->
    {% if not data %}
      <p style="text-align:center; margin-top:40px; font-size:1.1rem;">
        ‚ö†Ô∏è –ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel-—Ñ–∞–π–ª, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–∞—à–±–æ—Ä–¥.
      </p>
    {% else %}
      <div class="flex">

        <!-- –ì—Ä–∞—Ñ–∏–∫ -->
        <div class="card full" id="chart-container">
          <h3>üìà –ì—Ä–∞—Ñ–∏–∫ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤</h3>
          <canvas id="incidentChart"></canvas>
        </div>

        <!-- –ò–Ω—Å–∞–π—Ç—ã -->
        <div class="card">
          <h3>üß† –ö–ª—é—á–µ–≤—ã–µ –∏–Ω—Å–∞–π—Ç—ã</h3>
          <ul>
            {% for insight in data.insights %}
              <li>{{insight}}</li>
            {% endfor %}
          </ul>
        </div>

        <!-- –ü—Ä–æ–≥–Ω–æ–∑ -->
        <div class="card">
          <h3>üîÆ –ü—Ä–æ–≥–Ω–æ–∑</h3>
          <p>{{data.forecast}}</p>
        </div>

        <!-- –ü—Ä–∏—á–∏–Ω—ã -->
        <div class="card">
          <h3>üìå –ü—Ä–∏—á–∏–Ω—ã ({{data.reasons|length}})</h3>
          {% for reason, incs in data.reasons.items() %}
            <details class="relation-item" data-incs="{{incs|join(',')}}">
              <summary>
                {{reason}}
                <span class="count-badge">{{incs|length}}</span>
              </summary>
              <div class="badges">
                {% for inc in incs %}
                  <span class="badge incident-badge" data-inc="{{inc}}">{{inc}}</span>
                {% endfor %}
              </div>
            </details>
          {% endfor %}
          {% if not data.reasons %}
            <p><i>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø—Ä–∏—á–∏–Ω–∞–º</i></p>
          {% endif %}
        </div>

        <!-- –í–∏–Ω–æ–≤–Ω–∏–∫–∏ -->
        <div class="card">
          <h3>üë§ –í–∏–Ω–æ–≤–Ω–∏–∫–∏ ({{data.blame|length}})</h3>
          {% for name, incs in data.blame.items() %}
            <details class="relation-item" data-incs="{{incs|join(',')}}">
              <summary>
                {{name}}
                <span class="count-badge">{{incs|length}}</span>
              </summary>
              <div class="badges">
                {% for inc in incs %}
                  <span class="badge incident-badge" data-inc="{{inc}}">{{inc}}</span>
                {% endfor %}
              </div>
            </details>
          {% endfor %}
          {% if not data.blame %}
            <p><i>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º</i></p>
          {% endif %}
        </div>

        <!-- –ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã -->
        <div class="card">
          <h3>üìÑ –ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã</h3>
          <details class="relation-item" data-incs="{{data.incidents|join(',')}}">
            <summary>
              –í—Å–µ–≥–æ ‚Äî {{data.incidents|length}}
              <span class="count-badge">{{data.incidents|length}}</span>
            </summary>
            <div class="badges">
              {% for inc in data.incidents %}
                <span class="badge incident-badge" data-inc="{{inc}}">{{inc}}</span>
              {% endfor %}
            </div>
          </details>
        </div>

        <!-- Jira-–∑–∞–¥–∞—á–∏ -->
        <div class="card">
          <h3>üß© Jira-–∑–∞–¥–∞—á–∏ ({{data.jira|length}})</h3>
          {% for item in data.jira %}
            <details class="relation-item" data-incs="{{item.incidents|join(',')}}">
              <summary>
                {{item.jira}}
                <span class="count-badge">{{item.incidents|length}}</span>
              </summary>
              <div class="badges">
                {% for inc in item.incidents %}
                  <span class="badge incident-badge" data-inc="{{inc}}">{{inc}}</span>
                {% endfor %}
              </div>
              <p style="margin-top:8px; font-size:0.9rem;">
                <a class="jira-link" href="{{item.url}}" target="_blank">
                  –û—Ç–∫—Ä—ã—Ç—å {{item.jira}}
                </a>
              </p>
            </details>
          {% endfor %}
          {% if not data.jira %}
            <p><i>–ù–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö Jira-–∑–∞–¥–∞—á</i></p>
          {% endif %}
        </div>

      </div><!-- /.flex -->

      <script>
        // ============
        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
        // ============
        const overlay    = document.getElementById('loader-overlay');
        const overlayTxt = document.getElementById('loader-text');
        const toast      = document.getElementById('upload-toast');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ—Å—Ç
        function showToast(text, type='success') {
          toast.textContent = text;
          toast.style.background = (type==='success')
            ? 'var(--primary)' : 'var(--border)';
          toast.style.display = 'block';
          setTimeout(()=> toast.style.display = 'none', 3000);
        }

        // –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ –∫–æ–¥—ã –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞
        let pinnedCodes = [];

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º
        document.querySelectorAll('nav a').forEach(link => {
          link.addEventListener('click', e => {
            e.preventDefault();
            overlayTxt.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö‚Ä¶';
            overlay.style.display = 'flex';
            setTimeout(()=> window.location = link.href, 600);
          });
        });

        // Custom-–ø–µ—Ä–∏–æ–¥
        {% if selected=='custom' %}
        document.getElementById('apply-custom').addEventListener('click', e => {
          e.preventDefault();
          const sd = document.getElementById('from_date').value;
          const ed = document.getElementById('to_date').value;
          const gb = document.getElementById('group_by').value;
          const params = new URLSearchParams();
          params.set('period','custom');
          if(sd) params.set('from_date', sd);
          if(ed) params.set('to_date', ed);
          params.set('group_by', gb);
          overlayTxt.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö‚Ä¶';
          overlay.style.display = 'flex';
          setTimeout(()=> window.location = '/?' + params.toString(), 600);
        });
        {% endif %}

        // AJAX-–∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
        document.getElementById('upload-form').addEventListener('submit', e => {
          e.preventDefault();
          overlayTxt.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞‚Ä¶';
          overlay.style.display = 'flex';
          const xhr = new XMLHttpRequest();
          xhr.open('POST','/',true);
          xhr.onload = () => {
            overlay.style.display = 'none';
            xhr.status===200
              ? showToast('‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ')
              : showToast('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏','error');
          };
          xhr.onerror = () => {
            overlay.style.display = 'none';
            showToast('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞','error');
          };
          xhr.send(new FormData(e.target));
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ Chart.js
        const histLabels   = {{data.monthly.labels|tojson}};
        const histPoints   = {{data.monthly.points|tojson}};
        const fcLabels     = {{data.forecast_labels|tojson}};
        const fcPoints     = {{data.forecast_points|tojson}};
        const allLabels    = histLabels.concat(fcLabels);
        const realData     = histPoints.concat(Array(fcLabels.length).fill(null));
        const forecastData = Array(histLabels.length).fill(null).concat(fcPoints);

        const ctx = document.getElementById('incidentChart').getContext('2d');
        new Chart(ctx, {
          type:'line',
          data:{
            labels:allLabels,
            datasets:[
              {
                label:'–ò–Ω—Ü–∏–¥–µ–Ω—Ç—ã',
                data:realData,
                borderColor:'#333',
                fill:false,
                tension:0.4,
                pointRadius:5
              },
              {
                label:'–ü—Ä–æ–≥–Ω–æ–∑',
                data:forecastData,
                borderColor:'#000',
                borderDash:[6,4],
                borderWidth:2,
                fill:false,
                tension:0.4,
                pointRadius:6
              }
            ]
          },
          options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{
              legend:{ labels:{ color:'#333', font:{ size:14, weight:'600'} } },
              tooltip:{ titleColor:'#fff', bodyColor:'#fff', backgroundColor:'#333' }
            },
            scales:{
              x:{ grid:{color:'#EEE'}, ticks:{color:'#555'} },
              y:{ beginAtZero:true, grid:{color:'#EEE'}, ticks:{color:'#555'} }
            }
          }
        });

        // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏
        function clearHighlights() {
          document.querySelectorAll('.highlight')
            .forEach(el => el.classList.remove('highlight'));
          document.querySelectorAll('.badge.active')
            .forEach(el => el.classList.remove('active'));
        }

        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ summary –∏ –±–µ–π–¥–∂–∏
        function highlightSummary(codes) {
          clearHighlights();
          // summary
          document.querySelectorAll('.relation-item').forEach(det => {
            const incs = det.dataset.incs.split(',');
            if(incs.some(c=> codes.includes(c))) {
              det.querySelector('summary').classList.add('highlight');
            }
          });
          // –±–µ–π–¥–∂–∏
          document.querySelectorAll('.incident-badge').forEach(badge=>{
            if(codes.includes(badge.dataset.inc)) {
              badge.classList.add('active');
            }
          });
        }

        // –°–±—Ä–æ—Å –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
        document.querySelector('main').addEventListener('click', e=>{
          if(!e.target.closest('summary') && !e.target.closest('.incident-badge')) {
            pinnedCodes = [];
            clearHighlights();
          }
        });

        // Hover –ø–æ summary: –≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞
        document.querySelectorAll('.relation-item summary').forEach(summary=>{
          const det   = summary.parentElement;
          const codes = det.dataset.incs.split(',');
          summary.addEventListener('mouseenter', ()=>{
            if(pinnedCodes.length===0) highlightSummary(codes);
          });
          summary.addEventListener('mouseleave', ()=>{
            if(pinnedCodes.length===0) clearHighlights();
          });
          // –ö–ª–∏–∫ –ø–æ summary: –∑–∞–∫—Ä–µ–ø–ª—è–µ—Ç –ø–æ–¥—Å–≤–µ—Ç–∫—É –±–ª–æ–∫–∞ (all relations)
          summary.addEventListener('click', e=>{
            // –Ω–µ –æ—Ç–º–µ–Ω—è–µ–º —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ ‚Äî <details> —Å–¥–µ–ª–∞–µ—Ç —ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            pinnedCodes = codes;          // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã
            highlightSummary(codes);      // –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤–µ—Å—å –±–ª–æ–∫
          });
        });

        // Hover –∏ click –ø–æ –±–µ–π–¥–∂–∞–º-–∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞–º
        document.querySelectorAll('.incident-badge').forEach(badge=>{
          const code = badge.dataset.inc;
          badge.addEventListener('mouseenter', ()=>{
            if(pinnedCodes.length===0) highlightSummary([code]);
          });
          badge.addEventListener('mouseleave', ()=>{
            if(pinnedCodes.length===0) clearHighlights();
          });
          badge.addEventListener('click', ()=>{
            pinnedCodes = [code];
            highlightSummary([code]);
          });
        });
      </script>
    {% endif %}
  </main>
</body>
</html>
